hostname blackfin
mount -t proc proc /proc
mount -t ramfs ramfs /var
mount -t sysfs sysfs /sys
mount -t devpts devpts /dev/pts
[ -d /proc/bus/usb ] && mount -t usbfs usbfs /proc/bus/usb
[ -d /sys/kernel/debug ] && mount -t debugfs debugfs /sys/kernel/debug
[ -d /proc/sys/fs/binfmt_misc ] && mount -t binfmt_misc binfmt_misc /proc/sys/fs/binfmt_misc
[ -d /sys/kernel/security ] && mount -t securityfs securityfs /sys/kernel/security
grep -qs nfsd /proc/filesystems && mount -t nfsd nfsd /proc/fs/nfsd
if [ -e /bin/mdev ] ; then
	echo /bin/mdev 2>/dev/null > /proc/sys/kernel/hotplug
	/bin/mdev -s 2> /dev/null
fi
mkdir /var/tmp /var/log /var/run /var/lock

# Mount the application flash to /app
echo "Mounting Application Flash..."
mkdir /app
mount -t jffs2 /dev/mtdblock3 /app

echo "Loading Memory DMA kernel module..."
insmod /lib/modules/`uname -r`/bfdma.ko

# Configure network interface based on SPI EEPROM info
#dhcpcd &
ln -sfn /sys/bus/spi/devices/spi0.4/eeprom /eeprom 
ifconfig eth0 down
ifconfig eth0 192.168.1.1
ifconfig eth0 hw 00:20:e3:22:00:00
ifconfig eth0 up

ifconfig eth0 down
if test -e /eeprom
then
	ifconfig eth0 hw ether `grep "MAC" /eeprom | awk '{print $2}'`
	ifconfig eth0 `grep "IP" /eeprom | awk '{print $2}'`
fi
ifconfig eth0 up

ifconfig lo 127.0.0.1
inetd &

echo -n "Set MAC from EEPROM otherwise default: " 
ifconfig eth0 | grep "HWaddr" | awk '{print $5}'
echo -n "Set IP from EEPROM otherwise default: "
ifconfig eth0 | grep "inet" | awk '{print $2}' | sed -e s/addr://g

# send out two arp request to itselfe
arping -c 2 -w 1 `ifconfig eth0 | grep "inet" | awk '{print $2}' | sed -e s/addr://g`

#cat /etc/issue
cat /etc/motd

#start webserver
echo "Starting Webserver"
boa -f /etc/boa.conf&

#lunch application with priority: 1. drupaRun, 2. maintenance
if test -e /app/drupaRun.sh && test -e /app/app
then
	/app/./drupaRun.sh
else
	if test -e /app/maintenance
	then
		/app/./maintenance
	fi
fi
