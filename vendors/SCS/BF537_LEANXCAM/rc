hostname blackfin
mount -t proc proc /proc
mount -t ramfs ramfs /var
mount -t sysfs sysfs /sys
mount -t devpts devpts /dev/pts
[ -d /proc/bus/usb ] && mount -t usbfs usbfs /proc/bus/usb
[ -d /sys/kernel/debug ] && mount -t debugfs debugfs /sys/kernel/debug
[ -d /proc/sys/fs/binfmt_misc ] && mount -t binfmt_misc binfmt_misc /proc/sys/fs/binfmt_misc
[ -d /sys/kernel/security ] && mount -t securityfs securityfs /sys/kernel/security
grep -qs nfsd /proc/filesystems && mount -t nfsd nfsd /proc/fs/nfsd
if [ -e /bin/mdev ] ; then
	echo /bin/mdev 2>/dev/null > /proc/sys/kernel/hotplug
	/bin/mdev -s 2> /dev/null
fi
mkdir /var/tmp /var/log /var/run /var/lock

# Create meaningful soft links for /dev/mtd* 
ln -sfn /dev/mtd1 /dev/uboot
ln -sfn /dev/mtd2 /dev/env_uboot
ln -sfn /dev/mtd3 /dev/env_uboot_r
ln -sfn /dev/mtd4 /dev/linux
ln -sfn /dev/mtd5 /dev/calib

# Mount the application flash to /mnt/app
echo "Mounting Application Flash..."
mkdir /mnt/app
mount -t jffs2 /dev/mtdblock6 /mnt/app

echo "Loading Memory DMA kernel module..."
insmod /lib/modules/`uname -r`/bfdma.ko


# Detect first-time-boot if not valid u-boot environment available

if test "`fw_printenv | grep ethaddr`" = ""
then
	echo "No config\n\n"
	ifconfig eth0 down
	ifconfig eth0 hw ether 00:20:e3:23:00:00
	ifconfig eth0 192.168.11.10
	route add -net default gw 192.168.11.1
	ifconfig eth0 up
	tftp 192.168.11.2 -g -r runinit.sh -l /home/runinit.sh

	if test -e /home/runinit.sh
	then
	       cd /home
	       chmod +x runinit.sh
	       ./runinit.sh &
	       cd /
	fi
else
	ifconfig eth0 down
	ifconfig eth0 hw ether `fw_printenv | grep "ethaddr" | sed -e s/ethaddr=//g`
	ifconfig eth0 `fw_printenv | grep "ipaddr=" | sed -e s/ipaddr=//g`
	route add -net default gw `fw_printenv | grep "gatewayip=" | sed -e s/gatewayip=//g`
	echo ifconfig eth0 `fw_printenv | grep "ipaddr=" | sed -e s/ipaddr=//g`
	ifconfig eth0 up
fi


ifconfig lo 127.0.0.1
inetd &

# Send out two gratuitious arp request
arping -c 2 -w 1 `ifconfig eth0 | grep "inet" | awk '{print $2}' | sed -e s/addr://g`

#cat /etc/issue
cat /etc/motd

#start webserver
echo "Starting Webserver"
boa -f /etc/boa.conf&

#launch user specific application script
if test -e /dev/app/runapp.sh
then
       cd /dev/app
       ./runapp.sh &
       cd /
fi

