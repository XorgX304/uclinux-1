.EXPORT_ALL_VARIABLES:
############################################################################
#
# Vendor specific settings
#

ifndef CONSOLE_BAUD_RATE
CONSOLE_BAUD_RATE = 57600
endif

############################################################################
#
# The makefiles need to know how to do things in different contexts
# To save some pain we put it all here
#
# First settings we always want for all builds
#

# ARCH = kernel,  TARGET_ARCH = uClibc

MACHINE        = bfin
ARCH           = blackfin
ENDIAN         = little

UCLINUX_BUILD_SET = 0		# have we set a special config below

# Pull in common definitions
include $(ROOTDIR)/vendors/config/common/config.arch

ifndef DISABLE_SHARED_LIBS
  ifeq ($(CONFIG_FMT_USE_SHARED_FLAT),y)
	BUILD_SHARED = 1
  endif

  ifeq ($(CONFIG_FMT_USE_FDPIC_ELF),y)
	BUILD_FDPIC_ELF = 1
	CROSS_COMPILE = bfin-linux-uclibc-
	CONFIGURE_HOST = bfin-linux-uclibc
  else	
	CROSS_COMPILE  = bfin-uclinux-
	CONFIGURE_HOST = bfin-uclinux
  endif

  ifeq ($(CONFIG_FMT_USE_SEP_DATA),y)
	BUILD_SEP_DATA = 1
  endif
endif

CROSS          = $(CROSS_COMPILE)

CONFIG_UCLINUX=y

CC        = $(CROSS_COMPILE)gcc
AS        = $(CROSS_COMPILE)as
CXX       = $(CROSS_COMPILE)g++
AR        = $(CROSS_COMPILE)ar
LD        = $(CROSS_COMPILE)ld
OBJCOPY   = $(CROSS_COMPILE)objcopy
RANLIB    = $(CROSS_COMPILE)ranlib
ELF2FLT   = $(CROSS_COMPILE)elf2flt
STRIPTOOL = $(CROSS_COMPILE)strip
STRIP     = $(STRIPTOOL)
CC_FOR_BUILD = gcc

UCLINUX_BUILD_SET = 0		# have we set a special config below

# These can be used by configure.
CONFIGURE_BUILD := $(shell sh $(ROOTDIR)/tools/config.guess)
CONFIGURE_OPTS  := \
	--host=$(CONFIGURE_HOST) \
	--build=$(CONFIGURE_BUILD) \
	--target=$(CONFIGURE_HOST) \
	--prefix=/usr \
	--sysconfdir=/etc \
	--datadir=/usr/share \
	--mandir=/usr/share/man \
	--infodir=/usr/share/info \
	--localstatedir=/var/lib

############################################################################
#
# General purpose lib building rules,  uClibc.config uses these when
# possible
#

ifdef UCLINUX_BUILD_LIB
  ifdef CONFIG_LIB_DEBUG
	CFLAGS  :=  -O0 -g
	STRIPTOOL = echo
	STRIP     = $(STRIPTOOL)
  else
	CFLAGS  :=  -O2
  endif
	CFLAGS  += -pipe
	CFLAGS  += -fno-builtin -Wall #-fno-common -Werror
	CFLAGS  += $(VENDOR_CFLAGS) -DEMBED
  ifdef CONFIG_BLACKFIN_CHECK_STACKFLOW
	CFLAGS  += -mstack-check-l1
  endif
  ifdef BUILD_SHARED
	CFLAGS  += -fpic -mid-shared-library 
  endif
  ifdef BUILD_FDPIC_ELF
	CFLAGS += -mfdpic
	LDFLAGS += -mfdpic
  endif
  ifdef BUILD_SEP_DATA
	CFLAGS += -msep-data
	LDFLAGS += -msep-data
  endif

	# don't want all the CFLAGS for uClibc/Config
	ARCH_CFLAGS := $(CPUFLAGS) $(CFLAGS)
	CFLAGS  += -D__uClinux__

	CXXFLAGS = $(CFLAGS) $(INCCXX) -fno-exceptions

	UCLINUX_BUILD_SET=1
endif

############################################################################
#
# Settings for building user apps
#

ifdef UCLINUX_BUILD_USER

	GCC_DIR = $(shell $(CC) -v 2>&1|grep specs|sed -e 's/.* \(.*\)specs/\1\./')

  ifdef BUILD_SHARED
	FLAT_LIBC     := $(shell $(CC) -mid-shared-library -print-file-name=libc.gdb)
	LIBC	      = -Wl,-R,$(FLAT_LIBC)
  else
	LIBC          = $(SLIBC)
  endif

  ifdef CONFIG_USER_DEBUG
	CFLAGS  :=  -O0 -g
  else
	CFLAGS  := -O2
  endif
	CFLAGS  += -Wall -D__uClinux__ -DEMBED
	CFLAGS  += -fno-builtin
  ifdef CONFIG_BLACKFIN_CHECK_STACKFLOW
	CFLAGS  += -mstack-check-l1
  endif

  ifdef BUILD_SHARED
	CFLAGS  += -fpic -mid-shared-library -mshared-library-id=0
  endif
  ifdef BUILD_FDPIC_ELF
	CFLAGS += -mfdpic
	LDFLAGS = -mfdpic
  else
	LDFLAGS = -Wl,-elf2flt
  ifdef BUILD_SEP_DATA
	CFLAGS += -msep-data
	LDFLAGS += -msep-data
  endif
  endif
	CXXFLAGS := $(CFLAGS) $(INCCXX) -fno-exceptions
	CFLAGS  += -I$(ROOTDIR)

	LDLIBS   = $(LDPATH)

	CXXLIBS  = $(LIBSTDCPP) $(LIBIBERTY) $(LIBC) $(LIBGCC)
  ifdef BUILD_SHARED
	LDFLAGS += -Wl,-shared-lib-id,0 -mid-shared-library
  	LDFLAGS += $(LDPATH)
	LDLIBS         = $(LIBC)
	LDLIBS_static  = $(SLIBC)
  endif	

	FLTFLAGS :=
	export FLTFLAGS

	# for anyone still using it
	CONVERT = /bin/true

	UCLINUX_BUILD_SET=1
endif

############################################################################
#
# fall through,  do other config options perhaps
#

ifeq ($(UCLINUX_BUILD_SET),1)
	EXTRA_CFLAGS := $(CPUFLAGS)

	CXXLIBS = $(LIBSTDCPP) $(CXXSUP)

	CFLAGS   += -isystem $(STAGEDIR)/usr/include
	CPPFLAGS += -isystem $(STAGEDIR)/usr/include
	LDFLAGS  += -B$(STAGEDIR)/usr/lib
endif

############################################################################
