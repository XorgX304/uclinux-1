#!/usr/bin/expect

source ../kernel_config.exp
source ../board_info.exp
log_file [log_file_name "$argv0"]
send_user "Starting $argv0\n"
set TITLE [title "$argv0"]

step "Start kermit."
source ../spawn_kermit.exp

step "Reboot the kernel."
source ../reboot_kernel.exp

step "Starting test."

set case_num 0

incr case_num

set timeout 8
set flag 0

if { $board_type == "BF537-STAMP" } {

                        
			expect "root:~>"
			send -s "modprobe bfin_mac\r"
			while 1 {
			expect {
			-re ".* registered" {
				send_log "\nCase $case_num ...PASS\n"
				puts "\nmodule insert success.\n"
				break
			}
			
			timeout {
				send_log "\nCase $case_num ...FAIL\n"
				send_log "$TITLE ............\[FAIL\]\n"
				exit
				}
			}
			}
			
			incr case_num
			
			expect "root:~>"
			send -s "lsmod\r"
			while 1 {
			expect {
			"bfin_mac" {
				send_log "\nCase $case_num ...PASS\n"
				puts "\nmodule ls success.\n"
				break
			}
			
			timeout {
				send_log "\nCase $case_num ...FAIL\n"
				send_log "$TITLE ............\[FAIL\]\n"
				exit
				}
			}
			}


} elseif { $board_type == "BF533-STAMP" } {
                       	expect "root:~>"
						
			send -s "modprobe smc91x\r"
			while 1 {
			expect {
			"eth0: Ethernet addr" {
				send_log "\nCase $case_num ...PASS\n"
				puts "\nmodule insert success.\n"
				break
			}
			
			timeout {
				send_log "\nCase $case_num ...FAIL\n"
				send_log "$TITLE ............\[FAIL\]\n"
				exit
				}
			}
			}
			
			incr case_num
			
			expect "root:~>"
			send -s "lsmod\r"
			while 1 {
			expect {
			"smc91x" {
				send_log "\nCase $case_num ...PASS\n"
				puts "\nmodule ls success.\n"
				break
			}
			
			timeout {
				send_log "\nCase $case_num ...FAIL\n"
				send_log "$TITLE ............\[FAIL\]\n"
				exit
				}
			}
			}
}

incr case_num

expect "root:~>"
send -s "ifconfig eth0 $targetip\r" 
while 1 {
   sleep 3
   expect {
      "~>" { 
         send_log "\nCase $case_num ...PASS\n"
         break
      }

      timeout {                           
        send_log "\nCase $case_num ...FAIL\n"
	send_log "$TITLE ............\[FAIL\]\n"
	exit
         }
     }
}


send -s "ifconfig\r" 
while 1 {
   expect {
      "$targetip" { 
         break
      }

      timeout {                           
         break
         }
     }
}

incr case_num

expect "root:~>"
send -s "ping $serverip\r" 
while 1 {
   expect {
      "icmp_seq" { 
       sleep 10
       send "\003"
       send_log "\nCase $case_num ...PASS\n"
         break
      }

      timeout {                           
        send_log "\nCase $case_num ...FAIL\n"
	send_log "$TITLE ............\[FAIL\]\n"
	exit
         }
     }
}

incr case_num

expect "root:~>"
set timeout 50

if { $board_type == "BF537-STAMP" } {

	send -s  "rmmod bfin_mac\r"
	while 1 {
	expect {
	"root:~>" {
		send_log "\nCase $case_num ...PASS\n"
		break
	}
	
	timeout {
		send_log "\nCase $case_num ...FAIL\n"
		send_log "$TITLE ............\[FAIL\]\n"
		exit
		}
	}
	}

} elseif { $board_type == "BF533-STAMP" } {

	send -s  "rmmod smc91x\r" 
	while 1 {
	expect {
	"root:~>" {    
		send_log "\nCase $case_num ...PASS\n"   
		break
	}
	
	timeout {
		send_log "\nCase $case_num ...FAIL\n"
		send_log "$TITLE ............\[FAIL\]\n"
		exit
		}
	}
	}
}

incr case_num

if { $board_type == "BF537-STAMP" } {

send -s "lsmod\r" 
while 1 {
   expect {
   
      "bfin_mac" { 
        send_log "\nCase $case_num ...FAIL\n"
	send_log "$TITLE ............\[FAIL\]\n"
	exit
         }
	 
      "root:~>" {
         send_log "\nCase $case_num ...PASS\n"
         break
      }
      
      timeout { 
        send_log "\nCase $case_num ...FAIL\n"
	send_log "$TITLE ............\[FAIL\]\n"
	exit
         }
     }
}
} elseif { $board_type == "BF533-STAMP" } {

send -s "lsmod\r" 
while 1 {
   expect {
   
      "smc91x" { 
        send_log "\nCase $case_num ...FAIL\n"
	send_log "$TITLE ............\[FAIL\]\n"
	exit
         }
	 
      "root:~>" {
         send_log "\nCase $case_num ...PASS\n"
         break
      }

      timeout { 
        send_log "\nCase $case_num ...FAIL\n"
	send_log "$TITLE ............\[FAIL\]\n"
	exit
         }
     }
}
}

send_log "\n"
send_log "\n$TITLE ............\[PASS\]\n"

send_user "Ending $argv0\n"
log_file
 

