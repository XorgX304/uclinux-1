#!/usr/bin/expect

#
#Test program to test the KGDB patch.
#
source ../kernel_config.exp
log_file [log_file_name "$argv0"]
send_user "Starting $argv0\n"
set TITLE [title "$argv0"]

set targetip 10.100.4.2
set serverip 10.100.4.174

set argc [llength $argv]
if { $argc < 2} {
   puts "Usage:  $argv0 tty-device srcdir \[targetip serverip\]"
   puts "   where tty-device is something like /dev/ttyS0"
   puts ""
   exit
}
# grab the user specified parameters.
set srcdir             [lindex $argv 1]

if { $argc >= 3} {
   set targetip           [lindex $argv 2]
}
if { $argc >= 4} {
   set serverip           [lindex $argv 3]
}


step "Start kermit."
source ../spawn_kermit.exp

step "Reboot the kernel."
source ../reboot_kernel.exp

step "Start $TITLE\r"

set timeout 10
set case_num 0

incr case_num
spawn bfin-uclinux-gdb $srcdir/linux-2.6.x/vmlinux
set gdb_id $spawn_id
while 1 {
      expect {
	"(gdb)" {
		send_log "\rCase $case_num ...PASS\r"
	 	break;
         }
         timeout {
		send_log "\rCase $case_num ...FAIL\r"
		send_log "$TITLE ............\[FAIL\]\r"
		exit
         }
      }
}

while 1 {
	incr case_num
	send "target remote udp:$targetip:6443\r"
	expect {
		"breakpoint () at kernel" {
			send_log "\rCase $case_num ...PASS\r"
			expect { 
				"(gdb) " {
				}
			}
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	incr case_num
	send "break kgdb_test\r"
	expect {
		"Breakpoint 1" {
			send_log "\rCase $case_num ...PASS\r"
			expect { 
				"(gdb) " {
				}
			}
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	incr case_num
	send "c\r"
	expect {
		"Continuing." {
			send_log "\rCase $case_num ...PASS\r"
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	incr case_num
	set spawn_id $kermit_spawn_id
	send "\r"
	expect {
		"> " {
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	send -s "cat /proc/kgdbtest\r"
	set spawn_id $gdb_id
	expect {
		"Breakpoint 1" {
			send_log "\rCase $case_num ...PASS\r"
		expect { 
			"(gdb) " {
			}
		}
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	incr case_num
	send "list\r"
	expect {
		"(gdb) " {
			send_log "\rCase $case_num ...PASS\r"
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	incr case_num
	send "c\r"
	expect {
		"Continuing." {
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	set spawn_id $kermit_spawn_id
	expect {
		"hello world!" {
			send_log "\rCase $case_num ...PASS\r"
		expect {
			"> " {
			}
		}
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	send -s "cat /proc/kgdbtest\r"
	set spawn_id $gdb_id
	expect {
		"Breakpoint 1" {
		expect {
			"(gdb) " {
			}
		}
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	incr case_num
	send "break 51\r"
	expect {
		"Breakpoint 2" {
		expect {
			send_log "\rCase $case_num ...PASS\r"
			"(gdb) " {
			}
		}
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	incr case_num
	send "bt\r"
	expect {
		"kgdb_test" {
			send_log "\rCase $case_num ...PASS\r"
		expect {
			"(gdb) " {
			}
		}
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	incr case_num
	send "c\r"
	expect {
		"Breakpoint 2" {
			send_log "\rCase $case_num ...PASS\r"
		expect {
			"(gdb) " {
			}
		}
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	incr case_num
	send "d 1\r"
	send "info break\r"
	expect {
		"1   breakpoint" {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
		"2   breakpoint" {
			send_log "\rCase $case_num ...PASS\r"
		expect {
			"(gdb) " {
			}
		}
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	incr case_num
	send "step\r"
	expect {
		"test_read_proc" {
			send_log "\rCase $case_num ...PASS\r"
		expect {
			"(gdb) " {
			}
		}
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	incr case_num
	send "print len\r"
	expect {
		"1 =" {
			send_log "\rCase $case_num ...PASS\r"
		expect {
			"(gdb) " {
			}
		}
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	send "c\r"
	expect {
		"Continuing." {
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	set spawn_id $kermit_spawn_id
	expect {
		"hello world!" {
		expect {
			"> " {
			}
		}
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	send -s "cat /proc/kgdbtest\r"
	set spawn_id $gdb_id
	expect {
		"Breakpoint 2" {
		expect {
			"(gdb) " {
			}
		}
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	incr case_num
	send "d\r"
	expect {
		"Delete all breakpoints? (y or n)" {
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	send "y\r"
	expect {
		"(gdb) " {
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	send "info break\r"
	expect {
		"No breakpoints or watchpoints." {
			send_log "\rCase $case_num ...PASS\r"
		expect {
			"(gdb) " {
			}
		}
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	incr case_num
	send "c\r"
	expect {
		"Continuing." {
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	set spawn_id $kermit_spawn_id
	expect {
		"hello world!" {
			send_log "\rCase $case_num ...PASS\r"
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	expect {
		"> " {
		}
	}
	incr case_num
	set spawn_id $gdb_id
	send "\3"
	expect {
		"breakpoint" {
			send_log "\rCase $case_num ...PASS\r"
		expect {
			"(gdb) " {
			}
		}
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	incr case_num
	send "detach\r"
	expect {
		"Ending remote debugging." {
			send_log "\rCase $case_num ...PASS\r"
		expect {
			"(gdb) " {
			}
		}
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	send "q\r"
	set spawn_id $kermit_spawn_id
	incr case_num
	send "\r"
	expect {
		"> " {
			send_log "\rCase $case_num ...PASS\r"
			break
		}
		timeout {
			send_log "\rCase $case_num ...FAIL\r"
			send_log "$TITLE ............\[FAIL\]\r"
			exit
		}
	}
	
}
   
send_log "\r$TITLE ............\[PASS\]\r"

send_user "Ending $argv0\n"
log_file

